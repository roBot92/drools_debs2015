//created on: 2017.03.29.
package onlab.event




//list any import classes here.
//import accumulate MedianAccumulateFunction medianf
import onlab.positioning.*
import org.kie.api.runtime.rule.QueryResults
import java.math.BigDecimal
import java.util.ArrayList
import onlab.utility.CustomTreeMultiset



//declare any global variables here
global onlab.utility.ProfitableAreaToplistSet mostProfitableAreas
global onlab.utility.FrequentRoutesToplistSet mostFrequentRoutes



declare TaxiLog
@role(event)
@timestamp(dropoff_datetime)
//@expires( 32m )
end

declare Tick
@role(event)
@timestamp(currentTime)
@expires( 1s )
end

declare RefreshRoute
@role(event)
@timestamp(currentTime)
end 






declare RefreshArea
@role(event)
@timestamp(currentTime)
end

declare ActivateArea
@role(event)
end

declare ReOrderAreas
@role(event)
end

declare AreaWithProfit
@role(event)
@timestamp(lastInserted)
end





rule "task2_new_TaxiLog_rule" 
salience 0
    when
      $tlog: TaxiLog(!processed, $pickupCell: pickup_cell , $dropoffCell: dropoff_cell , $currentTime: dropoff_datetime )
      
    then
      $tlog.setProcessed(true); 
      update($tlog);
      insertLogical(new ActivateArea($pickupCell, $currentTime));
      insertLogical(new RefreshArea($pickupCell,$currentTime));  
      insertLogical(new ReOrderAreas());

end



rule "task2_ActivateAreaRule"
salience 10
	when
		ActivateArea($cell : cell, $ctime: currentTime) 
		not AreaWithProfit($cell == cell)
	then
		insert(new AreaWithProfit($cell, $ctime)); 
end




rule "task2_refreshAreaRule"
salience 20
	when
		RefreshArea($ctime: currentTime, $cell:cell)
		$area:AreaWithProfit($cell == cell, lastInserted.getTime()+15*60*1000 >= $ctime.getTime())
		
		$median : java.math.BigDecimal() from accumulate 
        			( TaxiLog($fare: fare_amount , $tip:tip_amount , pickup_cell == $cell, pickup_datetime.getTime()+15*60*1000 >= $ctime.getTime() ),
        			init(CustomTreeMultiset list = new CustomTreeMultiset();),
        			action(
        				list.add($fare.add($tip));
        			),
        			reverse(list.remove($fare.add($tip));),
        			result(list.getMedian())
        			)
        $taxiListOfArea: java.util.ArrayList() from collect (TaxiLog(dropoff_cell == $cell) over window:time(30m)) 
	then	
	
		int $numOfEmptyTaxis= 0;
		for(Object $o : $taxiListOfArea){
			TaxiLog $tlog = (TaxiLog)$o;
			QueryResults results =
    		kcontext.getKnowledgeRuntime().getQueryResults( "task2_newerRidesOfDriver", new Object[]{$tlog.getHack_license(), $tlog.getDropoff_datetime()} );
    		if(results.size() == 0 ){
    			$numOfEmptyTaxis++;
    		}
		}
		
		BigDecimal $medianProfit = ((BigDecimal)$median).divide(($numOfEmptyTaxis == 0 ? BigDecimal.ONE : BigDecimal.valueOf($numOfEmptyTaxis)),2, BigDecimal.ROUND_HALF_UP);
		if(!$medianProfit.equals($area.getMedianProfit())){
			$area.setMedianProfit($medianProfit);
			$area.setLastInserted($ctime);
			update($area);
		}
		
end



rule "task2_deactivateArea"
salience 25
	when
		RefreshArea($ctime: currentTime, $cell:cell)
		$area:AreaWithProfit($cell == cell, lastInserted.getTime()+15*60*1000 < $ctime.getTime())
	then
		retract($area);
end			



rule "task2_remove_TaxiLog_from_pickupCell"
salience 5
    when
        $tick:Tick($currentTime : currentTime )
        $tlog:TaxiLog(dropoff_datetime.getTime() + 15 * 60 * 1000 < $currentTime, !olderThanAQuarter, $pickupCell : pickup_cell)
    then
    	$tlog.setOlderThanAQuarter(true);
    	update($tlog);
    	insertLogical(new RefreshArea($pickupCell, new java.util.Date($currentTime)));
       	insertLogical(new ReOrderAreas());
        

end

rule "task2_remove_TaxiLog_from_WM"
salience 5
    when
        $tick:Tick($currentTime : currentTime )
        $tlog:TaxiLog(dropoff_datetime.getTime() + 30 * 60 * 1000 < $currentTime, $dropoffCell : dropoff_cell)
    then
    	retract($tlog);
    	insertLogical(new RefreshArea($dropoffCell, new java.util.Date($currentTime)));
       	insertLogical(new ReOrderAreas());
        

end

rule "task2_ReorderAreas_rule"
salience 5
	when
		ReOrderAreas()
		$areas:  java.util.ArrayList() from collect( AreaWithProfit() )
	then
		mostProfitableAreas.clear();
		if($areas != null){
		mostProfitableAreas.addAll($areas);
		}
		
end	

rule "task2_NoAreas"
salience 5
	when
		ReOrderAreas()
		not AreaWithProfit()
	then
		mostProfitableAreas.clear();
		
end	


rule "task2_removeAreaFromWM"
salience 5
	when
		Tick($currentTime : currentTime )
		$area:AreaWithProfit(lastInserted.getTime() + 15 * 60 * 1000 < $currentTime)
	then
		retract($area);
		insertLogical(new ReOrderAreas());
end

/*
rule "task1_refreshRoute"
salience 100
	when
		RefreshRoute($pickupCell:pickup_cell , $dropoffCell:dropoff_cell )
		TaxiLog(!mostFrequentRoutes.containsRoute($pickupCell, $dropoffCell), $refPickupCell: pickup_cell, $refDropoffCell: dropoff_cell)
		$countOfRoutes : java.lang.Number(doubleValue > 0) from accumulate 
        			( TaxiLog( pickup_cell == $refPickupCell , dropoff_cell == $refDropoffCell, pickup_cell  != null, dropoff_cell != null) over window:time(30m),
        			count()
        			)
        $maxDate : java.lang.Number() from accumulate 
        			( TaxiLog( pickup_cell == $refPickupCell , dropoff_cell == $refDropoffCell, pickup_cell  != null, dropoff_cell != null, $dropoffDate: dropoff_datetime) over window:time(30m),
        			 max($dropoffDate.getTime())
        			)
	then
	
	
		mostFrequentRoutes.add(new Route($refPickupCell, $refDropoffCell, new java.util.Date($maxDate.longValue()), (java.lang.Long) $countOfRoutes));
		
	
end




rule "task1_TaxiLog_rule"

    when
        $tlog: TaxiLog(!processed,$pickupCell : pickup_cell , $dropoffCell : dropoff_cell , $dropoffTime : dropoff_datetime)
        $countOfRoutes : java.lang.Number(doubleValue > 0) from accumulate 
        			( TaxiLog( pickup_cell == $pickupCell , dropoff_cell == $dropoffCell, pickup_cell  != null, dropoff_cell != null) over window:time(30m),
        			count()
        			)
    then
    
    	
    	 $tlog.setProcessed(true); 
    	 update($tlog);
    	
    	
    	mostFrequentRoutes.add(new Route($pickupCell, $dropoffCell, $dropoffTime, (java.lang.Long) $countOfRoutes));
  
       
        

end

rule "task1_TaxiLog_decrease"
    salience 50
    when
        $tick:Tick($currentTime : currentTime )
        $tlog:TaxiLog((dropoff_datetime.getTime() + 30 * 60 * 1000) < $currentTime, $pickupCell: pickup_cell, $dropoffCell: dropoff_cell)
    then 
    
    	mostFrequentRoutes.decreaseRouteFrequency($pickupCell, $dropoffCell);
    	retract($tlog);	
     	insertLogical(new RefreshRoute($pickupCell, $dropoffCell, $currentTime));
        

end
*/


query "task2_newerRidesOfDriver"  (String $license, java.util.Date $threshold)

      tlog:TaxiLog(hack_license.equals($license) , $threshold.before(dropoff_datetime) )
end

//For debug
query "areas"  ()

      areas:AreaWithProfit()
end

query "taxis"()
	taxis: TaxiLog()
end

